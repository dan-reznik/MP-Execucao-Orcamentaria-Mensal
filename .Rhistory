locale=locale_bra,
n_max=100,
trim_ws = T,
skip_empty_rows = T) %>%
count(row,name="seps") %>%
count(seps)
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
trim_ws = T,
skip_empty_rows = T) %>%
count(row,name="seps") %>%
count(seps)
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
trim_ws = T,
skip_empty_rows = T) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if(n()<20) list(row) else list())
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
trim_ws = T,
skip_empty_rows = T) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list()))
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
trim_ws = T,
skip_empty_rows = T,
n_max=100) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=list(row))
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
trim_ws = T,
skip_empty_rows = T,
n_max=100) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list(row)))
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
trim_ws = T,
skip_empty_rows = T,
n_max=100) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list()))
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
trim_ws = T,
skip_empty_rows = T,
n_max=100) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list(""))
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
trim_ws = T,
skip_empty_rows = T,
n_max=100) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list("")))
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
trim_ws = T,
skip_empty_rows = T,
n_max=100) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list(NA)))
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
trim_ws = T,
skip_empty_rows = T,
n_max=1000) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list(NA)))
melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,trim_ws = T
,skip_empty_rows = T
#,n_max=1000
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list(NA)))
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,trim_ws = T
,skip_empty_rows = T
#,n_max=1000
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list(NA)))
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,trim_ws = T
,skip_empty_rows = T
#,n_max=1000
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list(NA)))
df_melt1 %>% View
View(df_melt1)
read_lines(fname1_txt,locale=locale_bra)[6617]
read_lines(fname1_txt,locale=locale_bra)[6617]%>%str_count(fixed(";"))
read_lines(fname1_txt,locale=locale_bra)[1]%>%str_count(fixed(";"))
read_lines(fname1_txt,locale=locale_bra)[10]%>%str_count(fixed(";"))
read_lines(fname1_txt,locale=locale_bra)[6617]%>%str_count(fixed(";"))
read_lines(fname1_txt,locale=locale_bra)[6617]
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,quote="@"
,trim_ws = T
,skip_empty_rows = T
#,n_max=1000
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(row),list(NA)))
# df_melt1 %>% View
df_melt1
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,quote="@"
,trim_ws = T
,skip_empty_rows = T
#,n_max=1000
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,list(str_c(row,collapse=","),list(NA)))
df_melt1
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,quote="@"
,trim_ws = T
,skip_empty_rows = T
#,n_max=1000
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,
list(str_c(row,collapse=",")),
list(NA)))
df_melt1
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,quote="@"
,trim_ws = T
,skip_empty_rows = T
,n_max=1000
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,
list(str_c(row,collapse=",")),
list(NA)))
df_melt1
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,quote="@"
,trim_ws = T
,skip_empty_rows = T
,n_max=1000
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,
str_c(row,collapse=","),
list(NA)))
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,quote="@"
,trim_ws = T
,skip_empty_rows = T
,n_max=1000
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,
str_c(row,collapse=","),
NA_character_))
df_melt1
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,quote="@"
,trim_ws = T
,skip_empty_rows = T
,n_max=10000
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,
str_c(row,collapse=","),
NA_character_))
df_melt1
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,quote="@"
,trim_ws = T
,skip_empty_rows = T
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,
str_c(row,collapse=","),
NA_character_))
df_melt1
df_probs <- tibble(sep_cnt=read_lines(fname1_txt,locale=locale_bra)%>%
str_count(fixed(";")))%>%
mutate(row=row_number())%>%
filter(sep_cnt!=45)%>%
select(row,sep_cnt) %>%
arrange(sep_cnt) #%>%
df_probs
df_probs <- tibble(sep_cnt=read_lines(fname1_txt,locale=locale_bra)%>%
str_count(fixed(";")))%>%
mutate(row=row_number())%>%
filter(sep_cnt!=45)%>%
select(row,sep_cnt) %>%
arrange(sep_cnt) %>%
group_by(sep_cnt)%>%
summarize(n=n(),row_list=str_c(row,collapse=","))
df_probs
df_probs <- tibble(sep_cnt=read_lines(fname1_txt,locale=locale_bra)%>%
str_count(fixed(";")))%>%
mutate(row=row_number())%>%
filter(sep_cnt!=45)%>%
select(row,sep_cnt) %>%
arrange(sep_cnt) %>%
group_by(sep_cnt)%>%
summarize(n=n(),row_list=if_else(n()<20,
str_c(row,collapse=","),
NA_character_))
df_probs
df_probs <- tibble(sep_cnt=read_lines(fname1_txt,locale=locale_bra)%>%
str_count(fixed(";")))%>%
mutate(row=row_number())%>%
filter(sep_cnt!=45)%>%
select(row,sep_cnt) %>%
arrange(sep_cnt) %>%
group_by(sep_cnt)%>%
summarize(n=n(),row_list=str_c(head(row,20),collapse=","))
df_probs
df_probs <- tibble(sep_cnt=read_lines(fname1_txt,locale=locale_bra)%>%
str_count(fixed(";")))%>%
mutate(row=row_number())%>%
filter(sep_cnt!=45)%>%
select(row,sep_cnt) %>%
arrange(sep_cnt) %>%
group_by(sep_cnt)%>%
summarize(n=n(),row_list=str_c(head(row,10),collapse=","))
df_probs
df_probs <- tibble(sep_cnt=read_lines(fname1_txt,locale=locale_bra)%>%
str_count(fixed(";")))%>%
mutate(row=row_number())%>%
filter(sep_cnt!=45)%>%
select(row,sep_cnt) %>%
arrange(sep_cnt) %>%
group_by(sep_cnt)%>%
summarize(n=n(),row_list=str_c(head(row,10),if_else(n()>10,"...",""),collapse=","))
df_probs
df_probs <- tibble(sep_cnt=read_lines(fname1_txt,locale=locale_bra)%>%
str_count(fixed(";")))%>%
mutate(row=row_number())%>%
filter(sep_cnt!=45)%>%
select(row,sep_cnt) %>%
arrange(sep_cnt) %>%
group_by(sep_cnt)%>%
summarize(n=n(),row_list=str_c(head(row,10),collapse=","))
df_probs
df_probs <- tibble(sep_cnt=read_lines(fname1_txt,locale=locale_bra)%>%
str_count(fixed(";")))%>%
mutate(row=row_number())%>%
filter(sep_cnt!=45)%>%
select(row,sep_cnt) %>%
arrange(sep_cnt) %>%
group_by(sep_cnt)%>%
summarize(n=n(),row_list=str_c(head(row,10),collapse=","))%>%
mutate(row_list=if_else,n>10,str_c(row_list,",..."))
df_probs <- tibble(sep_cnt=read_lines(fname1_txt,locale=locale_bra)%>%
str_count(fixed(";")))%>%
mutate(row=row_number())%>%
filter(sep_cnt!=45)%>%
select(row,sep_cnt) %>%
arrange(sep_cnt) %>%
group_by(sep_cnt)%>%
summarize(n=n(),row_list=str_c(head(row,10),collapse=","))%>%
mutate(row_list=if_else(n>10,str_c(row_list,",..."),row_list))
df_probs
knitr::opts_chunk$set(
cache=T,
collapse=T,
comment="#>",
dpi=96
)
library(tidyverse)
library(lubridate)
library(fs)
library(stringi) # for %s+%
library(furrr)
library(zip)
library(tictoc)
source("util.R")
data_dir <- "data"
dir_ls(data_dir,regexp=".*zip")
fname_zip <- dir_slash_fname(data_dir,"Despesas MRJ.zip")
fnames_in_zip <- zip_list(fname_zip)
fnames_in_zip
fname1 <- fnames_in_zip$filename[1]
zip::unzip(fname_zip,files=fname1,exdir=data_dir)
dir_ls(data_dir,regexp="*.TXT")
fname1_txt <- dir_slash_fname(data_dir,fname1) %>%
path_norm
fname1_txt
guess_encoding(fname1_txt)
locale_bra <- locale(encoding="ISO-8859-1",
decimal_mark = ",",
date_format="%d/%m/%Y")
first2 <- read_lines(fname1_txt,
locale=locale_bra,n_max=2)
first2
first2 %>% cnt_seps(";")
read_lines(fname1_txt,locale=locale_bra) %>%
cnt_seps(";")
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
n_max=100,
trim_ws = T,
skip_empty_rows = T) %>%
write_delim("tests/melt100.txt",delim='|')
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,quote="@"
,trim_ws = T
,skip_empty_rows = T
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,
str_c(row,collapse=","),
NA_character_))
df_melt1
cnt_seps_df(fname1_txt,locale_bra,";",45)
cnt_seps_df(fname1_txt,locale_bra,";",45,5)
bad_lines <- read_lines(fname1_txt,locale=locale_bra)%>%
keep(~str_count(.x,fixed(";"))!=45)
c(first2[1],bad_lines)%>%write_lines("tests/bad_lines.txt")
{
lgts<-c(first2,bad_lines)%>%str_split(fixed(";"))%>%map_int(length)
cols<-str_c(c(letters,LETTERS),lgts)
df_transp <- c(first2,bad_lines)%>%
str_split(fixed(";"))%>%
map2(lgts,~c(.x,rep(NA,49-.y))) %>%
{l<-.;do.call(data.frame,l%>%set_names(cols%>%head(length(l))))}
df_transp%>%write_delim('tests/bad_lines_transp.txt',delim="|")
}
read_delim("tests/bad_lines_transp.txt",
delim=fixed("|")) %>%
mutate_all(~str_sub(.,end=10))
#%>%View
trunc_cols(fname1_txt,locale_bra,
max_cols=46,n_max=10)%>%
str_count(fixed(";"))%>%
table
trunc_cols(fname1_txt,locale_bra,
max_cols=46,n_max=10)%>%
cnt_seps
trunc_cols(fname1_txt,locale_bra,
max_cols=46,n_max=10)%>%
cnt_seps(";")
fnames <- zip_list(fname_zip) %>% pull(filename)
repl_ext(fnames,"rds") %>%
dir_slash_fname(data_dir,.) %>%
walk(~if(file_exists(.))file_delete(.))
tic()
plan(multiprocess)
fnames[2] %>%
furrr::future_map_chr(~{
#print(.x)
unzip(fname_zip,files=.x,exdir=data_dir)
trunc_to_rds(dir_slash_fname(data_dir,.x),locale_bra,45) # em util.R
f_txt <- dir_slash_fname(data_dir,.x)
f_utf8 <- get_fname_utf8(f_txt)
file_delete(f_txt)
file_delete(f_utf8)
.x
})
source('~/Dropbox/Data Science/R Projects/MP-Execucao-Mensal/util.R', echo=TRUE)
tic()
plan(multiprocess)
fnames[2] %>%
furrr::future_map_chr(~{
#print(.x)
unzip(fname_zip,files=.x,exdir=data_dir)
trunc_to_rds(dir_slash_fname(data_dir,.x),locale_bra,45) # em util.R
f_txt <- dir_slash_fname(data_dir,.x)
f_utf8 <- get_fname_utf8(f_txt)
file_delete(f_txt)
file_delete(f_utf8)
.x
})
toc()
tic()
plan(multiprocess)
# fnames[2] %>%
fnames %>%
furrr::future_map_chr(~{
#print(.x)
unzip(fname_zip,files=.x,exdir=data_dir)
trunc_to_rds(dir_slash_fname(data_dir,.x),locale_bra,45) # em util.R
f_txt <- dir_slash_fname(data_dir,.x)
f_utf8 <- get_fname_utf8(f_txt)
file_delete(f_txt)
file_delete(f_utf8)
.x
})
toc()
tic()
plan(multiprocess)
fnames[2] %>%
# fnames %>%
furrr::future_map_chr(~{
#print(.x)
unzip(fname_zip,files=.x,exdir=data_dir)
trunc_to_rds(dir_slash_fname(data_dir,.x),locale_bra,45) # em util.R
f_txt <- dir_slash_fname(data_dir,.x)
f_utf8 <- get_fname_utf8(f_txt)
file_delete(f_txt)
file_delete(f_utf8)
.x
})
toc()
source('~/Dropbox/Data Science/R Projects/MP-Execucao-Mensal/util.R', echo=TRUE)
tic()
plan(multiprocess)
fnames[2] %>%
# fnames %>%
furrr::future_map_chr(unzip_trunc_rds,fname_zip,data_dir,locale_bra,45)
source('~/Dropbox/Data Science/R Projects/MP-Execucao-Mensal/util.R', echo=TRUE)
tic()
plan(multiprocess)
fnames[2] %>%
# fnames %>%
furrr::future_map_chr(unzip_trunc_rds,fname_zip,data_dir,locale_bra,45)
toc()
fname_rds1 <- dir_ls(data_dir,regexp="MP_EMPENHOS.*rds") %>%
sort %>%
first
df_rds1 <- fname_rds1 %>% read_rds
dim(df_rds1)
glimpse(df_rds1)
df_rds1 %>% get_card
fnames_rds <- dir_ls(path=data_dir,regexp="\\d{6}\\.rds$")
df_all <- fnames_rds %>%
map_dfr(~{
#print(.x)
read_rds(.x)%>%
# already taken care of at read_delim
mutate_at(vars(Elemento,SubFuncao,ContaCorrente),as.character)
}) %>%
mutate_if(is.character,as.factor)
fnames_rds <- dir_ls(path=data_dir,regexp="\\d{6}\\.rds$")
df_all <- fnames_rds %>%
map_dfr(read_rds) %>%
mutate_if(is.character,as.factor)
fnames_rds %>% walk(file_delete)
df_all %>%
arrange(Data) %>%
write_rds(dir_slash_fname(data_dir,"MP_EMPENHOS_ALL.rds"),
compress="bz")
gc()
unlink('preparo_mensal_cache', recursive = TRUE)
library(tidyverse)
library(fs)
fname_despesas <- "./data/Despesas MPRJ rds one.rds"
df_despesas <- read_rds(fname_despesas)
fname_despesas <- "./data/MP_EMPENHOS_ALL.rds"
df_despesas <- read_rds(fname_despesas)
dim(df_despesas)
object.size(df_despesas)%>%format(units="Mb")

library(fs)
fname_despesas <- "./data/Despesas MPRJ rds one.rds"
df_despesas <- read_rds(fname_despesas)
fname_despesas <- "./data/MP_EMPENHOS_ALL.rds"
df_despesas <- read_rds(fname_despesas)
dim(df_despesas)
object.size(df_despesas)%>%format(units="Mb")
library(tidyverse)
library(fs)
fname_despesas <- "./data/MP_EMPENHOS_ALL.rds"
tic()
library(tidyverse)
library(fs)
library(tictoc) # mede tempo de execução
fname_despesas <- "./data/MP_EMPENHOS_ALL.rds"
tic()
df_despesas <- read_rds(fname_despesas)
toc()
library(tidyverse)
library(lubridate)
library(fs)
library(tictoc) # mede tempo de execução
dim(df_despesas)
object.size(df_despesas)%>%format(units="Mb")
source("util.R")
df_despesas%>%get_card
df_despesas%>%colnanmes
df_despesas%>%colnames
df_despesas%>%glimpse
df_despesas%>%map_chr(class)
df_despesas%>%map_chr(class)%>%table
source('~/Dropbox/Data Science/R Projects/MP-Execucao-Mensal/util.R', echo=TRUE)
df_despesas%>%get_card_fact()
df_despesas%>%get_card_fact
df_despesas %>% select_if(is.numeric) %>% colnames
```{r}
df_despesas %>% select_if(is.numeric) %>% summary
unlink('README_cache', recursive = TRUE)
df_despesas %>% map(~sum(is.na(.)))
knitr::opts_chunk$set(
cache=T,
collapse=T,
comment="#>",
dpi=96
)
library(tidyverse)
library(lubridate)
library(fs)
library(tictoc) # mede tempo de execução
source("util.R")
fname_despesas <- "./data/MP_EMPENHOS_ALL.rds"
tic()
df_despesas <- read_rds(fname_despesas)
toc()
dim(df_despesas)
object.size(df_despesas)%>%format(units="Mb")
df_despesas%>%glimpse
df_despesas %>% map_chr(class)%>%table
df_despesas %>% get_card_fact
df_despesas %>% select_if(is.numeric) %>% colnames
df_despesas %>% select_if(is.numeric) %>% summary
df_despesas %>% map(~sum(is.na(.)))
df_despesas %>% {tibble(col=colnames(.),
cnt_na=map(~sum(is.na(.))))}
df_despesas %>% {tibble(col=colnames(.),
cnt_na=map_int(~sum(is.na(.))))}
df_despesas %>% {tibble(col=colnames(.),
cnt_na=map_int(.,~sum(is.na(.))))}
df_despesas %>% {tibble(col=colnames(.),
cnt_na=map_int(.,~sum(is.na(.))))} %>%
arrange(cnt_na)
df_despesas %>% {tibble(col=colnames(.),
cnt_na=map_int(.,~sum(is.na(.))))} %>%
arrange(desc(cnt_na))
df_despesas %>% {tibble(col=colnames(.),
lines=nrow(.),
cnt_na=map_int(.,~sum(is.na(.))))} %>%
arrange(desc(cnt_na))
df_despesas %>% {tibble(col=colnames(.),
lines=nrow(.),
cnt_na=map_int(.,~sum(is.na(.))),
pct_na=cnt_na/lines)} %>%
arrange(desc(cnt_na))
df_despesas %>% {tibble(col=colnames(.),
lines=nrow(.),
cnt_na=map_int(.,~sum(is.na(.))),
pct_na=round(cnt_na/lines,2)} %>%
df_despesas %>% {tibble(col=colnames(.),
lines=nrow(.),
cnt_na=map_int(.,~sum(is.na(.))),
pct_na=round(cnt_na/lines,2))} %>%
arrange(desc(cnt_na))
source('~/Dropbox/Data Science/R Projects/MP-Execucao-Mensal/util.R', echo=TRUE)
df_despesas %>% pct_na
source('~/Dropbox/Data Science/R Projects/MP-Execucao-Mensal/util.R', echo=TRUE)
df_despesas %>% pct_na
source('~/Dropbox/Data Science/R Projects/MP-Execucao-Mensal/util.R', echo=TRUE)
df_despesas %>% pct_na
source('~/Dropbox/Data Science/R Projects/MP-Execucao-Mensal/util.R', echo=TRUE)
df_despesas %>% pct_na %>% filter(pct_na>.8)
knitr::opts_chunk$set(
cache=T,
collapse=T,
comment="#>",
dpi=96
)
library(tidyverse)
library(lubridate)
library(fs)
library(tictoc) # mede tempo de execução
source("util.R")
fname_despesas <- "./data/MP_EMPENHOS_ALL.rds"
tic()
df_despesas <- read_rds(fname_despesas)
toc()
dim(df_despesas)
object.size(df_despesas)%>%format(units="Mb")
df_despesas%>%glimpse
df_despesas %>% map_chr(class)%>%table
df_despesas %>% get_card_fact
df_despesas %>% select_if(is.numeric) %>% colnames
df_despesas %>% select_if(is.numeric) %>% summary
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<5) %>%
ggplot(aes(NomeFuncao,Valor)) +
geom_boxplot()
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>%
ggplot(aes(NomeFuncao,Valor,fill=NomeFuncao)) +
geom_boxplot() +
scale_y_log10() +
theme(legend.position = "none")
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,median,.desc=T)) %>%
ggplot(aes(NomeFuncao,Valor,fill=NomeFuncao)) +
geom_boxplot() +
scale_y_log10() +
theme(legend.position = "none")
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,median,.desc=T),
ano=year(Data)) %>%
group_by(ano,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(ano,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line() +
theme(legend.position = "none")
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,median,.desc=T),
ano=year(Data)) %>%
group_by(ano,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(ano,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line() +
theme(legend.position = "top")
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
ano=year(Data)) %>%
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(ano=year(Data)) %>%
group_by(ano,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(ano,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line() +
theme(legend.position = "top")
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(ano=year(Data)) %>%
group_by(ano,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(ano,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top")
yq("2019/10/10")
lubridate::yq("2019/10/10")
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(yq=str_c(year(Data),"_",quarter(Data)%>%as.factor) %>%
group_by(yq,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(yq,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top")
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(yq=str_c(year(Data),"_",quarter(Data))%>%as.factor) %>%
group_by(yq,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(yq,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top")
knitr::opts_chunk$set(
cache=T,
collapse=T,
comment="#>",
dpi=96
)
library(tidyverse)
library(lubridate)
library(fs)
library(tictoc) # mede tempo de execução
source("util.R")
fname_despesas <- "./data/MP_EMPENHOS_ALL.rds"
tic()
df_despesas <- read_rds(fname_despesas)
toc()
dim(df_despesas)
object.size(df_despesas)%>%format(units="Mb")
df_despesas%>%glimpse
df_despesas %>% map_chr(class)%>%table
df_despesas %>% get_card_fact
df_despesas %>% select_if(is.numeric) %>% colnames
df_despesas %>% select_if(is.numeric) %>% summary
df_despesas %>% pct_na %>% filter(pct_na>.1)
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,median,.desc=T)) %>%
ggplot(aes(NomeFuncao,Valor,fill=NomeFuncao)) +
geom_boxplot() +
scale_y_log10() +
theme(legend.position = "none")
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(ano=year(Data)) %>%
group_by(ano,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(ano,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top")
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(yq=str_c(str_sub(year(Data),start=3),
"_",quarter(Data))%>%as.factor) %>%
group_by(yq,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(yq,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top")
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(yq=str_c(str_sub(year(Data),start=3),
"_",quarter(Data))%>%as.factor) %>%
group_by(yq,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(yq,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top",
axis.text.x = element_text(angle = 90))
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(yq=str_c(year(Data),"_",quarter(Data))%>%as.factor) %>%
group_by(yq,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(yq,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top",
axis.text.x = element_text(angle = -90))
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(yq=str_c(year(Data),"_",quarter(Data))%>%as.factor) %>%
group_by(yq,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(yq,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top",
axis.text.x = element_text(angle = 45))
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(yq=str_c(year(Data),"_",quarter(Data))%>%as.factor) %>%
group_by(yq,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(yq,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top",
axis.text.x = element_text(angle = 45,hjust=0))
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(yq=str_c(year(Data),"_",quarter(Data))%>%as.factor) %>%
group_by(yq,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(yq,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top",
axis.text.x = element_text(angle = 45,hjust=-1))
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(yq=str_c(year(Data),"_",quarter(Data))%>%as.factor) %>%
group_by(yq,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(yq,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top",
axis.text.x = element_text(angle = 45,hjust=2))
df_despesas %>%
mutate(NomeFuncao=NomeFuncao%>%
fct_reorder(Valor,sum,.desc=T)) %>%
filter(as.integer(NomeFuncao)<6) %>% # top by overall sum
mutate(yq=str_c(year(Data),"_",quarter(Data))%>%as.factor) %>%
group_by(yq,NomeFuncao) %>%
summarize(Valor=sum(Valor)) %>%
ggplot(aes(yq,Valor,group=NomeFuncao,color=NomeFuncao)) +
geom_line(size=1.2) +
theme(legend.position = "top",
axis.text.x = element_text(angle = 45,hjust=1,vjust=1))
?read_delim
library(readr)
?read_delim
knitr::opts_chunk$set(
cache=T,
collapse=T,
comment="#>",
dpi=96
)
knitr::opts_chunk$set(
cache=T,
collapse=T,
comment="#>",
dpi=96
)
library(tidyverse)
library(lubridate)
library(fs)
library(stringi) # for %s+%
library(furrr)
library(zip)
library(tictoc)
source("util.R")
data_dir <- "data"
dir_ls(data_dir,regexp=".*zip")
fname_zip <- dir_slash_fname(data_dir,"Despesas MRJ.zip")
fnames_in_zip <- zip_list(fname_zip)
fnames_in_zip
fname1 <- fnames_in_zip$filename[1]
zip::unzip(fname_zip,files=fname1,exdir=data_dir)
dir_ls(data_dir,regexp="*.TXT")
fname1_txt <- dir_slash_fname(data_dir,fname1) %>%
path_norm
fname1_txt
guess_encoding(fname1_txt)
locale_bra <- locale(encoding="ISO-8859-1",
decimal_mark = ",",
date_format="%d/%m/%Y")
first2 <- read_lines(fname1_txt,n_max=2,
locale=locale_bra)
first2
first2 <- read_lines(fname1_txt,n_max=2,
trim_ws=T,
locale=locale_bra)
first2 <- read_lines(fname1_txt,n_max=2,
locale=locale_bra)
first2
first2 <- read_lines(fname1_txt,n_max=2,
locale=locale_bra) %>%
str_squish()
first2
first2 %>% cnt_seps(";")
read_lines(fname1_txt,locale=locale_bra) %>%
cnt_seps(";")
melt_delim(fname1_txt,
delim=fixed(";"),
locale=locale_bra,
n_max=100,
trim_ws = T,
skip_empty_rows = T) %>%
write_delim("tests/melt100.txt",delim='|')
df_melt1 <- melt_delim(fname1_txt
,delim=fixed(";")
,locale=locale_bra
,quote="@"
,trim_ws = T
,skip_empty_rows = T
) %>%
count(row,name="seps") %>%
group_by(seps) %>%
summarize(n=n(),row_list=if_else(n()<20,
str_c(row,collapse=","),
NA_character_))
df_melt1
cnt_seps_df(fname1_txt,locale_bra,";",45,5)
bad_lines <- read_lines(fname1_txt,locale=locale_bra)%>%
keep(~str_count(.x,fixed(";"))!=45)
c(first2[1],bad_lines)%>%write_lines("tests/bad_lines.txt")
{
lgts<-c(first2,bad_lines)%>%str_split(fixed(";"))%>%map_int(length)
cols<-str_c(c(letters,LETTERS),lgts)
df_transp <- c(first2,bad_lines)%>%
str_split(fixed(";"))%>%
map2(lgts,~c(.x,rep(NA,49-.y))) %>%
{l<-.;do.call(data.frame,l%>%set_names(cols%>%head(length(l))))}
df_transp%>%write_delim('tests/bad_lines_transp.txt',delim="|")
}
read_delim("tests/bad_lines_transp.txt",
delim=fixed("|")) %>%
mutate_all(~str_sub(.,end=10))
#%>%View
trunc_cols(fname1_txt,locale_bra,
max_cols=46,n_max=10)%>%
cnt_seps(";")
fnames <- zip_list(fname_zip) %>% pull(filename)
repl_ext(fnames,"rds") %>%
dir_slash_fname(data_dir,.) %>%
walk(~if(file_exists(.))file_delete(.))
tic()
plan(multiprocess)
# fnames[2] %>%
fnames %>% future_map_chr(unzip_trunc_rds,
fname_zip,data_dir,locale_bra,45)
toc()
fname_rds1 <- dir_ls(data_dir,regexp="MP_EMPENHOS.*rds") %>%
sort %>%
first
df_rds1 <- fname_rds1 %>% read_rds
dim(df_rds1)
source('~/Dropbox/Data Science/R Projects/MP-Execucao-Mensal/util.R', echo=TRUE)
df_rds1 %>% get_card
fnames_rds <- dir_ls(path=data_dir,regexp="\\d{6}\\.rds$")
df_all <- fnames_rds %>%
map_dfr(read_rds) %>%
mutate_if(is.character,as.factor) %>%
arrange(Data)
fnames_rds %>% walk(file_delete)
df_all %>%
arrange(Data) %>%
write_rds(dir_slash_fname(data_dir,"MP_EMPENHOS_ALL.rds"),
compress="bz")
unlink('preparo_mensal_cache', recursive = TRUE)
1:10 %>% tail(-1)
library(magrittr); 1:10 %>% tail(-1)
read_rds("data/MP_EMPENHOS_ALL.rds") %>% filter(year(Data)==2014,month(Data)==01) -> df1
readr::read_rds("data/MP_EMPENHOS_ALL.rds") %>% filter(year(Data)==2014,month(Data)==01) -> df1
library(lubridate);readr::read_rds("data/MP_EMPENHOS_ALL.rds") %>% filter(year(Data)==2014,month(Data)==01) -> df1
library(lubridate);readr::read_rds("data/MP_EMPENHOS_ALL.rds") %>% filter(year(Data)==2014,month(Data)==01) %>% colnames
library(dplyr);library(readr)
library(lubridate);readr::read_rds("data/MP_EMPENHOS_ALL.rds") %>% filter(year(Data)==2014,month(Data)==01) -> df1
df1%>%write_rds("data/MP_EMPENHOS_201401.rds",compress = "gz")
unlink('preparo_mensal_cache', recursive = TRUE)
library(tidyverse)
library(lubridate)
library(fs)
library(stringi) # for %s+%
library(furrr)
library(zip)
library(tictoc)
source("util.R")
fname_rds1 <- dir_ls(data_dir,regexp="MP_EMPENHOS_\\d{6}.*rds") %>%
sort %>%
first
data_dir <- "data"
dir_ls(data_dir,regexp=".*zip")
data_dir <- "data"
dir_ls(data_dir,regexp=".*zip")
fname_rds1 <- dir_ls(data_dir,regexp="MP_EMPENHOS_\\d{6}.*rds") %>%
sort %>%
first
df_rds1 <- fname_rds1 %>% read_rds
dim(df_rds1)
glimpse(df_rds1)
df_rds1 %>% get_card
df_rds1 %>% get_card_fact
library(tidyverse)
library(lubridate)
library(fs)
library(stringi) # for %s+%
library(furrr)
library(zip)
library(tictoc)
source("util.R")
